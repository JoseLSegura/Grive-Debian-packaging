#!/usr/bin/make -f
# -*- makefile -*-

DEB_HOST_GNU_TYPE := $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE := $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
DB2MAN := /usr/share/xml/docbook/stylesheet/docbook-xsl/manpages/docbook.xsl
PACKAGE_VERSION=$(shell dpkg-parsechangelog --show-field Version | cut -d"-" -f1)

UPSTREAM_ORIG=../grive_$(PACKAGE_VERSION).orig.tar.xz


%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- -DBoost_USE_MULTITHREADED=OFF

override_dh_auto_build: debian/grive.1
	dh_auto_build

override_dh_auto_test:
	./obj-$(DEB_BUILD_GNU_TYPE)/libgrive/unittest

%.1: %.xml
	xsltproc -o $@ --param man.charmap.use.subset "0" --novalid --nonet $(DB2MAN) $<

.PHONY: create-orig
create-orig: $(UPSTREAM_ORIG)

$(UPSTREAM_ORIG):
	wget https://github.com/Grive/grive/archive/master.tar.gz
	tar xzf master.tar.gz
	rm master.tar.gz
	mv grive-master grive-$(PACKAGE_VERSION)
	tar -cf ../grive_$(PACKAGE_VERSION).orig.tar grive-$(PACKAGE_VERSION)
	$(RM) -r grive-$(PACKAGE_VERSION)
	xz ../grive_$(PACKAGE_VERSION).orig.tar
