#!/usr/bin/make -f
# -*- makefile -*-

DEB_HOST_GNU_TYPE := $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE := $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
DB2MAN := /usr/share/xml/docbook/stylesheet/docbook-xsl/manpages/docbook.xsl
PACKAGE_VERISON=$(shell head -1 debian/changelog | awk '{print $$2 }' | \
	tr -d '()' | cut -d"-" -f1)

UPSTREAM_ORIG=../grive_$(PACKAGE_VERISON).orig.tar.gz

.PHONY: create-orig

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- -DBoost_USE_MULTITHREADED=OFF

override_dh_auto_build: debian/grive.1
	dh_auto_build

override_dh_auto_test:
	./obj-$(DEB_BUILD_GNU_TYPE)/libgrive/unittest

%.1: %.xml
	xsltproc -o $@ --param man.charmap.use.subset "0" --novalid --nonet $(DB2MAN) $<

create-orig: ../grive_$(PACKAGE_VERISON).orig.tar.xz
	tar xfJ $^
	mv grive-master/* .
	rm -fr grive-master

$(UPSTREAM_ORIG):
	wget https://github.com/Grive/grive/archive/master.tar.gz -O $@

%.tar.xz: %.tar
	xz $^

%.tar: %.tar.gz
	gunzip $^
